# 819B单体测试环境

[TOC]

## 模拟器环境

根据`819b_java_UT.docx`文件配置好模拟器环境，成功编译模拟器。

然后启动模拟器(第一次初始化时间久一些)

启动模拟器后，进入adb，`service list`列出100+个service证明模拟器已完全启动。

## 手动测试

`819b_java_UT.docx`文档上的手动测试手顺，亲测成功的。

主要需要四个原料:

1. 测试apk
2. 源代码apk
3. coverate.em文件
4. coverage.ec文件

### 启动模拟器

`lxc start`

详细参考:`lxc --help`

adb也可以进入模拟器

### 编译源代码APP

`EMMA_INSTRUMENT=true EMMA_INSTRUMENT_STATIC=true make voiceassistant`

### 编译测试APP

`EMMA_INSTRUMENT=true EMMA_INSTRUMENT_STATIC=true make voiceassistanttest`

### 安装APP

`adb install -r -g out/target/product/tamago_1T/system/priv-app/voiceassistant/voiceassistant.apk`

`adb install -r -g out/target/product/tamago_1T/data/app/voiceassistanttest/voiceassistanttest.apk`

### 打印所有的测试包（可选）

`adb shell pm list instrumentation`

### 运行测试程序

```
adb shell am instrument -w -r -e coverage true jp.pioneer.ceam.voiceassistant.test/android.support.test.runner.AndroidJUnitRunner
```

### 拉取覆盖率报告coverage.ec文件

`adb pull /data/user/0/jp.pioneer.ceam.voiceassistant/files/coverage.ec /tmp/zuozuo`

### 拷贝coverage.em文件

`cp out/target/common/obj/APPS/voiceassistant_intermediates/coverage.em /tmp/zuozuo`

### 生成HTML测试报告

`java -jar prebuilts/sdk/tools/jack-jacoco-reporter.jar --metadata-file /tmp/zuozuo/coverage.em --coverage-file /tmp/zuozuo/coverage.ec --report-dir /tmp/zuozuo/ --source-dir device/pioneer/frameworks/VoiceServer/VoiceAssistant/app/src/main/java`

### 本地测试脚本

路径:

`./819B/device/pioneer/frameworks/VoiceServer/VoiceAssistant/app/src/androidTest/loc
altest.sh`

把这个文件放到根目录下运行

`bash localtest.sh`

## Suntest

> 截止到2019年11月29日 suntest 版本更新到3.8.0, 黄老师的脚本还是有问题
>
> 需要修改脚本
>
> * 模拟器完全启动里面的service 大约一百四十多个(141个)
> * adb shell 中`service list`可以查看
> * 本地普通PC机跑suntes需要该Suntest 配置文件和脚本才行。



### 更改的配置文件`819b.conf`

文本对比如下

![文件对比](./picture/819b.png)

这个字段，开发网PC需要设置，我们不需要设置，如果有无法跑出单体测试

### 等的久一些

> 模拟器启动的慢（黄斌代码写的烂）需要等待模拟器完全启动后才能安装APK。

需要更改`lxc.py`文件

文件路径在:`myproject/venv/lib/python2.7/site-packages/Suntest-3.8.0-py2.7.egg/suntest/device/emulator/lxc.py`

* Note: 路径为suntest 安装后的路径.

更改`126`行`time.sleep(30)`等待30秒.

![](./picture/lxc_py.png)

### 项目配置文件(已弃用)

可以在Suntest中找到`suntest/config/819b.conf`

下面的为武汉提供的`819b.conf`文件,大同小异。

```bash
[unittest]
compile_arch=ANDROID
device_type=lxc
kernel_path=prebuilts/qemu-kernel/x86_64/kernel-qemu
toolchain=x86_64-linux-android
jack_jacoco_reporter=prebuilts/sdk/tools/jack-jacoco-reporter.jar
android_version=Android8
lxc_start=./build/lxc.sh start
lxc_stop=./build/lxc.sh stop
lxc_info=./build/lxc.sh info
```

### 安装Suntest

[教程](http://iautowiki.storm/Group/UnitTest/UnitTestManual)

---

---

### 下面的运行环境是在虚拟环境中运行的



### lunch

进入根目录

```
source build/envsetup.sh
lunch lxc_x86_64-userdebug
```

### 启动模拟器

> 黄瑞庭说:"需要先启动模拟器然后再运行Suntest"

启动过程中需要root权限，输入以下密码。

```
lxc start
```

### 跑单体

* 跑的时候中途需要输入一次密码

```
suntest -p 819b -c /home/zuoshiyu/workspace/emulator/819B_ut/device/pioneer/frameworks/VoiceServer/.ciconfig/UnitTest.yaml -J -w /tmp/learn --loglevel DEBUG -j 4 --report-type html
```

## 遇到的问题集锦

### 无效的安装包

安装包，安装失败问题，肯能是yaml文件里面的成果物生成路径写错了。



### 安装失败问题

>INSTALL_FAILED_INVALID_APK: Package couldn't be installed in /data/app/jp.pioneer.ceam.voiceassistant-1: Package /data/app/jp.pioneer.ceam.voiceassistant-1/base.apk code is missing

原因是默认的编译有个编译优化，本地跑单体测试不能每次都编译模拟器一遍。

添加`LOCAL_DEX_PREOPT := false`


## 情报

### Demo

整个819B项目的单体测试demo路径:

`819B/vendor/anbox/test_sample`

### 写单体测试的注意事项

**注意**：基于Morley单体测试经验，当使用java的反射特性修改类成员的属性时。

**尤其是静态的私有成员时！**

**使用完成后一定要记得恢复现场！！**

**免得干扰其他的测试case！！！**



### 资料

#### java学习资料

Java学习网站适合查找资料、学习:[Jenkov](http://tutorials.jenkov.com)

适合萌新:[javaTpoint](https://www.javatpoint.com/java-tutorial)

IBM 的java教程:[Java编程入门](https://www.ibm.com/developerworks/cn/java/intro-to-java-course/index.html)

#### Junit4资料

[howtodoinjava](https://howtodoinjava.com/junit-4/)

[junit4 wiki](https://github.com/junit-team/junit4/wiki/Getting-started)

这个网页基本够了:[javacodehouse](https://javacodehouse.com/blog/junit-tutorial/)

[javaTpoint](https://www.javatpoint.com/junit-tutorial)

#### Mockito资料

[文档](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)

[这个网页就够了](https://javacodehouse.com/blog/mockito-tutorial/)

[萌新专用](https://www.journaldev.com/21816/mockito-tutorial)

#### Truth资料

谷歌整的适用于Java和Android的断言库

[官网](https://truth.dev)

#### PowerMock资料

由于Mockito有许多限制，可能用到PowerMock帮助

[完整教程](https://howtodoinjava.com/library/mock-testing-using-powermock-with-junit-and-mockito/)

[github wiki](https://github.com/powermock/powermock/wiki)

## 加油(ง •̀_•́)ง，你可以的！